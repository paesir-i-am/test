# 데이터베이스 설계서

## 1. 문서 정보

### 프로젝트명
**쑤카 (Sooka)**

### 문서 버전
v1.0

### 작성일
2024년 (작성일자)

### 문서 목적
쑤카 프로젝트의 데이터베이스 구조를 설계하여 데이터 일관성과 효율성을 보장합니다.

---

## 2. 데이터베이스 개요

### 2.1 데이터베이스 선택
- **주 데이터베이스**: PostgreSQL (또는 MySQL)
- **선택 이유**:
  - 관계형 데이터 구조에 적합
  - 트랜잭션 지원
  - 확장성 및 성능
  - 오픈소스

### 2.2 명명 규칙
- **테이블명**: 소문자, 복수형, 언더스코어 사용 (예: `users`, `vehicles`)
- **컬럼명**: 소문자, 언더스코어 사용 (예: `user_id`, `created_at`)
- **인덱스명**: `idx_테이블명_컬럼명` 형식
- **외래키명**: `fk_테이블명_참조테이블명` 형식

---

## 3. ERD (Entity Relationship Diagram)

### 3.1 주요 엔티티
1. **Users** (사용자)
2. **Vehicles** (차량)
3. **VehicleImages** (차량 이미지)
4. **Inquiries** (문의)
5. **Favorites** (찜하기)
6. **Manufacturers** (제조사)
7. **Models** (모델)
8. **Announcements** (공지사항)

### 3.2 관계도
```
Users (1) ──── (N) Vehicles
Users (1) ──── (N) Favorites
Users (1) ──── (N) Inquiries
Vehicles (1) ──── (N) VehicleImages
Vehicles (1) ──── (N) Favorites
Vehicles (1) ──── (N) Inquiries
Manufacturers (1) ──── (N) Models
Vehicles (N) ──── (1) Models
```

---

## 4. 테이블 설계

### 4.1 Users (사용자)

#### 테이블 정보
- **테이블명**: `users`
- **설명**: 시스템 사용자 정보를 저장

#### 컬럼 구조

| 컬럼명 | 데이터 타입 | 제약조건 | 설명 |
|--------|------------|----------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 사용자 고유 ID |
| email | VARCHAR(255) | UNIQUE, NOT NULL | 이메일 주소 |
| password | VARCHAR(255) | NOT NULL | 암호화된 비밀번호 |
| name | VARCHAR(100) | NOT NULL | 사용자 이름 |
| phone | VARCHAR(20) | NULL | 전화번호 |
| address | VARCHAR(255) | NULL | 주소 |
| role | ENUM('buyer', 'seller', 'both', 'admin') | NOT NULL, DEFAULT 'buyer' | 사용자 역할 |
| profile_image_url | VARCHAR(500) | NULL | 프로필 이미지 URL |
| status | ENUM('active', 'suspended', 'deleted') | NOT NULL, DEFAULT 'active' | 계정 상태 |
| last_login_at | TIMESTAMP | NULL | 마지막 로그인 시간 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 생성일시 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 수정일시 |

#### 인덱스
- `idx_users_email`: email (UNIQUE)
- `idx_users_role`: role
- `idx_users_status`: status

---

### 4.2 Manufacturers (제조사)

#### 테이블 정보
- **테이블명**: `manufacturers`
- **설명**: 차량 제조사 정보를 저장

#### 컬럼 구조

| 컬럼명 | 데이터 타입 | 제약조건 | 설명 |
|--------|------------|----------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 제조사 고유 ID |
| name | VARCHAR(100) | UNIQUE, NOT NULL | 제조사명 (예: 현대, 기아, BMW) |
| name_en | VARCHAR(100) | NULL | 제조사명 (영문) |
| logo_url | VARCHAR(500) | NULL | 로고 이미지 URL |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 생성일시 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 수정일시 |

#### 인덱스
- `idx_manufacturers_name`: name (UNIQUE)

---

### 4.3 Models (모델)

#### 테이블 정보
- **테이블명**: `models`
- **설명**: 차량 모델 정보를 저장

#### 컬럼 구조

| 컬럼명 | 데이터 타입 | 제약조건 | 설명 |
|--------|------------|----------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 모델 고유 ID |
| manufacturer_id | INT | FOREIGN KEY, NOT NULL | 제조사 ID |
| name | VARCHAR(100) | NOT NULL | 모델명 (예: 소나타, 아반떼) |
| name_en | VARCHAR(100) | NULL | 모델명 (영문) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 생성일시 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 수정일시 |

#### 인덱스
- `idx_models_manufacturer_id`: manufacturer_id
- `idx_models_name`: name

#### 외래키
- `fk_models_manufacturer`: manufacturer_id → manufacturers(id)

---

### 4.4 Vehicles (차량)

#### 테이블 정보
- **테이블명**: `vehicles`
- **설명**: 등록된 차량 정보를 저장

#### 컬럼 구조

| 컬럼명 | 데이터 타입 | 제약조건 | 설명 |
|--------|------------|----------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 차량 고유 ID |
| seller_id | BIGINT | FOREIGN KEY, NOT NULL | 판매자 ID |
| manufacturer_id | INT | FOREIGN KEY, NOT NULL | 제조사 ID |
| model_id | INT | FOREIGN KEY, NOT NULL | 모델 ID |
| detail_model_name | VARCHAR(100) | NULL | 상세 모델명 |
| year | INT | NOT NULL | 연식 (연도) |
| mileage | INT | NOT NULL | 주행거리 (km) |
| price | DECIMAL(12, 0) | NOT NULL | 가격 (원) |
| fuel_type | ENUM('gasoline', 'diesel', 'hybrid', 'electric', 'lpg') | NOT NULL | 연료 유형 |
| transmission | ENUM('manual', 'automatic') | NOT NULL | 변속기 유형 |
| color | VARCHAR(50) | NULL | 색상 |
| region | VARCHAR(100) | NOT NULL | 지역 |
| options | TEXT | NULL | 옵션 (JSON 형식) |
| accident_history | BOOLEAN | NOT NULL, DEFAULT FALSE | 사고 이력 유무 |
| accident_details | TEXT | NULL | 사고 상세 내용 |
| repair_history | TEXT | NULL | 수리 이력 |
| description | TEXT | NULL | 차량 설명 |
| vehicle_number | VARCHAR(20) | NULL | 차량 번호 |
| status | ENUM('pending', 'approved', 'sold', 'rejected', 'deleted') | NOT NULL, DEFAULT 'pending' | 차량 상태 |
| view_count | INT | NOT NULL, DEFAULT 0 | 조회수 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 생성일시 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 수정일시 |

#### 인덱스
- `idx_vehicles_seller_id`: seller_id
- `idx_vehicles_manufacturer_id`: manufacturer_id
- `idx_vehicles_model_id`: model_id
- `idx_vehicles_status`: status
- `idx_vehicles_price`: price
- `idx_vehicles_year`: year
- `idx_vehicles_mileage`: mileage
- `idx_vehicles_fuel_type`: fuel_type
- `idx_vehicles_region`: region
- `idx_vehicles_created_at`: created_at (최신순 정렬용)
- `idx_vehicles_search`: (manufacturer_id, model_id, status, price, year) (복합 인덱스)

#### 외래키
- `fk_vehicles_seller`: seller_id → users(id)
- `fk_vehicles_manufacturer`: manufacturer_id → manufacturers(id)
- `fk_vehicles_model`: model_id → models(id)

---

### 4.5 VehicleImages (차량 이미지)

#### 테이블 정보
- **테이블명**: `vehicle_images`
- **설명**: 차량 이미지 정보를 저장

#### 컬럼 구조

| 컬럼명 | 데이터 타입 | 제약조건 | 설명 |
|--------|------------|----------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 이미지 고유 ID |
| vehicle_id | BIGINT | FOREIGN KEY, NOT NULL | 차량 ID |
| image_url | VARCHAR(500) | NOT NULL | 이미지 URL |
| image_order | INT | NOT NULL, DEFAULT 0 | 이미지 순서 |
| is_thumbnail | BOOLEAN | NOT NULL, DEFAULT FALSE | 대표 이미지 여부 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 생성일시 |

#### 인덱스
- `idx_vehicle_images_vehicle_id`: vehicle_id
- `idx_vehicle_images_order`: (vehicle_id, image_order)

#### 외래키
- `fk_vehicle_images_vehicle`: vehicle_id → vehicles(id)

---

### 4.6 Favorites (찜하기)

#### 테이블 정보
- **테이블명**: `favorites`
- **설명**: 사용자가 찜한 차량 정보를 저장

#### 컬럼 구조

| 컬럼명 | 데이터 타입 | 제약조건 | 설명 |
|--------|------------|----------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 찜하기 고유 ID |
| user_id | BIGINT | FOREIGN KEY, NOT NULL | 사용자 ID |
| vehicle_id | BIGINT | FOREIGN KEY, NOT NULL | 차량 ID |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 생성일시 |

#### 인덱스
- `idx_favorites_user_id`: user_id
- `idx_favorites_vehicle_id`: vehicle_id
- `idx_favorites_user_vehicle`: (user_id, vehicle_id) (UNIQUE, 중복 방지)

#### 외래키
- `fk_favorites_user`: user_id → users(id) ON DELETE CASCADE
- `fk_favorites_vehicle`: vehicle_id → vehicles(id) ON DELETE CASCADE

---

### 4.7 Inquiries (문의)

#### 테이블 정보
- **테이블명**: `inquiries`
- **설명**: 구매자와 판매자 간 문의 정보를 저장

#### 컬럼 구조

| 컬럼명 | 데이터 타입 | 제약조건 | 설명 |
|--------|------------|----------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 문의 고유 ID |
| vehicle_id | BIGINT | FOREIGN KEY, NOT NULL | 차량 ID |
| buyer_id | BIGINT | FOREIGN KEY, NOT NULL | 구매자 ID |
| seller_id | BIGINT | FOREIGN KEY, NOT NULL | 판매자 ID |
| title | VARCHAR(200) | NOT NULL | 문의 제목 |
| content | TEXT | NOT NULL | 문의 내용 |
| reply | TEXT | NULL | 답변 내용 |
| reply_at | TIMESTAMP | NULL | 답변 일시 |
| status | ENUM('pending', 'replied') | NOT NULL, DEFAULT 'pending' | 문의 상태 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 생성일시 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 수정일시 |

#### 인덱스
- `idx_inquiries_vehicle_id`: vehicle_id
- `idx_inquiries_buyer_id`: buyer_id
- `idx_inquiries_seller_id`: seller_id
- `idx_inquiries_status`: status
- `idx_inquiries_created_at`: created_at

#### 외래키
- `fk_inquiries_vehicle`: vehicle_id → vehicles(id) ON DELETE CASCADE
- `fk_inquiries_buyer`: buyer_id → users(id) ON DELETE CASCADE
- `fk_inquiries_seller`: seller_id → users(id) ON DELETE CASCADE

---

### 4.8 Announcements (공지사항)

#### 테이블 정보
- **테이블명**: `announcements`
- **설명**: 공지사항 정보를 저장

#### 컬럼 구조

| 컬럼명 | 데이터 타입 | 제약조건 | 설명 |
|--------|------------|----------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 공지사항 고유 ID |
| admin_id | BIGINT | FOREIGN KEY, NOT NULL | 작성자(관리자) ID |
| title | VARCHAR(200) | NOT NULL | 제목 |
| content | TEXT | NOT NULL | 내용 |
| is_pinned | BOOLEAN | NOT NULL, DEFAULT FALSE | 고정 여부 |
| view_count | INT | NOT NULL, DEFAULT 0 | 조회수 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 생성일시 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 수정일시 |
| deleted_at | TIMESTAMP | NULL | 삭제일시 (Soft Delete) |

#### 인덱스
- `idx_announcements_admin_id`: admin_id
- `idx_announcements_is_pinned`: is_pinned
- `idx_announcements_created_at`: created_at

#### 외래키
- `fk_announcements_admin`: admin_id → users(id)

---

## 5. 데이터 관계 및 제약조건

### 5.1 참조 무결성
- 모든 외래키는 CASCADE 또는 RESTRICT 정책 적용
- 사용자 삭제 시 관련 데이터 처리:
  - 차량: `status`를 'deleted'로 변경 (Soft Delete)
  - 찜하기: CASCADE 삭제
  - 문의: CASCADE 삭제

### 5.2 데이터 검증
- 이메일 형식 검증 (애플리케이션 레벨)
- 비밀번호 강도 검증 (애플리케이션 레벨)
- 가격, 주행거리 등 숫자 값 범위 검증

### 5.3 Soft Delete
- Users: `status` 컬럼으로 관리
- Vehicles: `status` 컬럼으로 관리
- Announcements: `deleted_at` 컬럼 사용

---

## 6. 인덱스 전략

### 6.1 주요 인덱스
1. **검색 성능 향상**
   - Vehicles: (manufacturer_id, model_id, status, price, year) 복합 인덱스
   - Vehicles: created_at (최신순 정렬)

2. **조회 성능 향상**
   - Vehicles: seller_id (판매자별 차량 조회)
   - Favorites: (user_id, vehicle_id) (중복 방지 및 조회)

3. **정렬 성능 향상**
   - Vehicles: price, mileage, view_count (정렬 옵션)

### 6.2 인덱스 유지보수
- 정기적인 인덱스 재구성
- 사용하지 않는 인덱스 제거
- 쿼리 성능 모니터링

---

## 7. 데이터베이스 초기 데이터

### 7.1 제조사 데이터
```sql
INSERT INTO manufacturers (name, name_en) VALUES
('현대', 'Hyundai'),
('기아', 'Kia'),
('쉐보레', 'Chevrolet'),
('르노삼성', 'Renault Samsung'),
('쌍용', 'SsangYong'),
('BMW', 'BMW'),
('벤츠', 'Mercedes-Benz'),
('아우디', 'Audi'),
('폭스바겐', 'Volkswagen'),
('도요타', 'Toyota');
```

### 7.2 관리자 계정
```sql
INSERT INTO users (email, password, name, role) VALUES
('admin@sooka.com', '[암호화된 비밀번호]', '관리자', 'admin');
```

---

## 8. 백업 및 복구

### 8.1 백업 전략
- **일일 백업**: 매일 자정 자동 백업
- **주간 백업**: 매주 일요일 전체 백업
- **백업 보관**: 최소 30일 보관

### 8.2 복구 절차
1. 백업 파일 확인
2. 데이터베이스 복구
3. 데이터 무결성 검증
4. 서비스 재시작

---

## 9. 성능 최적화

### 9.1 쿼리 최적화
- N+1 문제 방지를 위한 JOIN 사용
- 필요한 컬럼만 SELECT
- LIMIT를 사용한 페이지네이션

### 9.2 캐싱 전략
- Redis를 사용한 검색 결과 캐싱
- 자주 조회되는 데이터 캐싱 (제조사, 모델 등)
- 캐시 TTL: 1시간

---

## 문서 승인

| 역할 | 이름 | 서명 | 날짜 |
|------|------|------|------|
| 프로젝트 매니저 | | | |
| 기술 리더 | | | |
| 데이터베이스 관리자 | | | |

---

**문서 버전**: 1.0  
**최종 수정일**: 2024년 (작성일자)  
**다음 리뷰일**: 프로젝트 진행 중 필요시 수정

